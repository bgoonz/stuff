{"version":3,"sources":["../browser/src/schema-builder/RdbmsSchemaBuilder.ts"],"names":[],"mappings":"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","file":"RdbmsSchemaBuilder.js","sourcesContent":["import {ForeignKeyMetadata} from \"../metadata/ForeignKeyMetadata\";\nimport {Table} from \"./schema/Table\";\nimport {TableColumn} from \"./schema/TableColumn\";\nimport {TableForeignKey} from \"./schema/TableForeignKey\";\nimport {TableIndex} from \"./schema/TableIndex\";\nimport {QueryRunner} from \"../query-runner/QueryRunner\";\nimport {TablePrimaryKey} from \"./schema/TablePrimaryKey\";\nimport {ColumnMetadata} from \"../metadata/ColumnMetadata\";\nimport {EntityMetadata} from \"../metadata/EntityMetadata\";\nimport {PromiseUtils} from \"../util/PromiseUtils\";\nimport {Connection} from \"../connection/Connection\";\nimport {SchemaBuilder} from \"./SchemaBuilder\";\n\n/**\n * Creates complete tables schemas in the database based on the entity metadatas.\n *\n * Steps how schema is being built:\n * 1. load list of all tables with complete column and keys information from the db\n * 2. drop all (old) foreign keys that exist in the table, but does not exist in the metadata\n * 3. create new tables that does not exist in the db, but exist in the metadata\n * 4. drop all columns exist (left old) in the db table, but does not exist in the metadata\n * 5. add columns from metadata which does not exist in the table\n * 6. update all exist columns which metadata has changed\n * 7. update primary keys - update old and create new primary key from changed columns\n * 8. create foreign keys which does not exist in the table yet\n * 9. create indices which are missing in db yet, and drops indices which exist in the db, but does not exist in the metadata anymore\n */\nexport class RdbmsSchemaBuilder implements SchemaBuilder {\n\n    // -------------------------------------------------------------------------\n    // Protected Properties\n    // -------------------------------------------------------------------------\n\n    /**\n     * Used to execute schema creation queries in a single connection.\n     */\n    protected queryRunner: QueryRunner;\n\n    /**\n     * All synchronized tables in the database.\n     */\n    protected tables: Table[];\n\n    // -------------------------------------------------------------------------\n    // Constructor\n    // -------------------------------------------------------------------------\n\n    constructor(protected connection: Connection) {\n    }\n\n    // -------------------------------------------------------------------------\n    // Public Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Creates complete schemas for the given entity metadatas.\n     */\n    async build(): Promise<void> {\n        this.queryRunner = await this.connection.createQueryRunner(\"master\");\n        await this.createNewDatabases();\n        await this.queryRunner.startTransaction();\n        try {\n            this.tables = await this.loadTableSchemas();\n            await this.executeSchemaSyncOperationsInProperOrder();\n\n            // if cache is enabled then perform cache-synchronization as well\n            if (this.connection.queryResultCache)\n                await this.connection.queryResultCache.synchronize(this.queryRunner);\n\n            await this.queryRunner.commitTransaction();\n\n        } catch (error) {\n\n            try { // we throw original error even if rollback thrown an error\n                await this.queryRunner.rollbackTransaction();\n            } catch (rollbackError) { }\n            throw error;\n\n        } finally {\n            await this.queryRunner.release();\n        }\n    }\n\n    /**\n     * Returns sql queries to be executed by schema builder.\n     */\n    async log(): Promise<(string|{ up: string, down: string })[]> {\n        this.queryRunner = await this.connection.createQueryRunner(\"master\");\n        try {\n            await this.createNewDatabases();\n            this.tables = await this.loadTableSchemas();\n            this.queryRunner.enableSqlMemory();\n            await this.executeSchemaSyncOperationsInProperOrder();\n\n            // if cache is enabled then perform cache-synchronization as well\n            if (this.connection.queryResultCache) // todo: check this functionality\n                await this.connection.queryResultCache.synchronize(this.queryRunner);\n\n            return this.queryRunner.getMemorySql();\n\n        } finally {\n            // its important to disable this mode despite the fact we are release query builder\n            // because there exist drivers which reuse same query runner. Also its important to disable\n            // sql memory after call of getMemorySql() method because last one flushes sql memory.\n            this.queryRunner.disableSqlMemory();\n            await this.queryRunner.release();\n        }\n    }\n\n    // -------------------------------------------------------------------------\n    // Protected Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Loads all tables from the database.\n     */\n    protected loadTableSchemas(): Promise<Table[]> {\n        const tablePaths = this.entityToSyncMetadatas.map(metadata => metadata.tablePath);\n        return this.queryRunner.getTables(tablePaths);\n    }\n\n    /**\n     * Returns only entities that should be synced in the database.\n     */\n    protected get entityToSyncMetadatas(): EntityMetadata[] {\n        return this.connection.entityMetadatas.filter(metadata => !metadata.skipSync && metadata.tableType !== \"single-table-child\");\n    }\n\n    /**\n     * Creates new databases if they are not exists.\n     */\n    protected async createNewDatabases(): Promise<void> {\n        const databases: string[] = [];\n        this.connection.entityMetadatas.forEach(metadata => {\n            if (metadata.database && databases.indexOf(metadata.database) === -1)\n                databases.push(metadata.database);\n        });\n\n        await Promise.all(databases.map(database => this.queryRunner.createDatabase(database!)));\n    }\n\n    /**\n     * Executes schema sync operations in a proper order.\n     * Order of operations matter here.\n     */\n    protected async executeSchemaSyncOperationsInProperOrder(): Promise<void> {\n        const schemaPaths: string[] = [];\n        this.connection.entityMetadatas\n            .filter(entityMetadata => !!entityMetadata.schemaPath)\n            .forEach(entityMetadata => {\n                const existSchemaPath = schemaPaths.find(path => path === entityMetadata.schemaPath);\n                if (!existSchemaPath)\n                    schemaPaths.push(entityMetadata.schemaPath!);\n            });\n        await this.queryRunner.createSchema(schemaPaths);\n\n        await this.dropOldForeignKeys();\n        // await this.dropOldPrimaryKeys(); // todo: need to drop primary column because column updates are not possible\n        await this.createNewTables();\n        await this.dropRemovedColumns();\n        await this.addNewColumns();\n        await this.updateExistColumns();\n        await this.updatePrimaryKeys();\n        await this.createIndices(); // we need to create indices before foreign keys because foreign keys rely on unique indices\n        await this.createForeignKeys();\n    }\n\n    /**\n     * Drops all (old) foreign keys that exist in the tables, but do not exist in the entity metadata.\n     */\n    protected async dropOldForeignKeys(): Promise<void> {\n        await PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n\n            const table = this.tables.find(table => table.name === metadata.tableName);\n            if (!table)\n                return;\n\n            // find foreign keys that exist in the schemas but does not exist in the entity metadata\n            const tableForeignKeysToDrop = table.foreignKeys.filter(tableForeignKey => {\n                return !metadata.foreignKeys.find(metadataForeignKey => metadataForeignKey.name === tableForeignKey.name);\n            });\n            if (tableForeignKeysToDrop.length === 0)\n                return;\n\n            this.connection.logger.logSchemaBuild(`dropping old foreign keys of ${table.name}: ${tableForeignKeysToDrop.map(dbForeignKey => dbForeignKey.name).join(\", \")}`);\n\n            // remove foreign keys from the table\n            table.removeForeignKeys(tableForeignKeysToDrop);\n\n            // drop foreign keys from the database\n            await this.queryRunner.dropForeignKeys(table, tableForeignKeysToDrop);\n        });\n    }\n\n    /**\n     * Creates tables that do not exist in the database yet.\n     * New tables are created without foreign and primary keys.\n     * Primary key only can be created in conclusion with auto generated column.\n     */\n    protected async createNewTables(): Promise<void> {\n        await PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n            // check if table does not exist yet\n            const existTableSchema = this.tables.find(table => {\n                if (table.name !== metadata.tableName)\n                    return false;\n\n                if (metadata.schema && table.schema !== metadata.schema)\n                    return false;\n\n                if (metadata.database && table.database !== metadata.database)\n                    return false;\n\n                return true;\n            });\n            if (existTableSchema)\n                return;\n\n            this.connection.logger.logSchemaBuild(`creating a new table: ${metadata.tableName}`);\n\n            // create a new table and sync it in the database\n            const table = new Table(metadata.tableName, this.metadataColumnsToTableColumns(metadata.columns), true, metadata.engine, metadata.database, metadata.schema);\n            this.tables.push(table);\n            await this.queryRunner.createTable(table);\n        });\n    }\n\n    /**\n     * Drops all columns that exist in the table, but does not exist in the metadata (left old).\n     * We drop their keys too, since it should be safe.\n     */\n    protected dropRemovedColumns() {\n        return PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n            const table = this.tables.find(table => table.name === metadata.tableName);\n            if (!table) return;\n\n            // find columns that exist in the database but does not exist in the metadata\n            const droppedTableColumns = table.columns.filter(tableColumn => {\n                return !metadata.columns.find(columnMetadata => columnMetadata.databaseName === tableColumn.name);\n            });\n            if (droppedTableColumns.length === 0)\n                return;\n\n            // drop all foreign keys that has column to be removed in its columns\n            await Promise.all(droppedTableColumns.map(droppedTableColumn => {\n                return this.dropColumnReferencedForeignKeys(metadata.tableName, droppedTableColumn.name);\n            }));\n\n            // drop all indices that point to this column\n            await Promise.all(droppedTableColumns.map(droppedTableColumn => {\n                return this.dropColumnReferencedIndices(metadata.tableName, droppedTableColumn.name);\n            }));\n\n            this.connection.logger.logSchemaBuild(`columns dropped in ${table.name}: ` + droppedTableColumns.map(column => column.name).join(\", \"));\n\n            // remove columns from the table and primary keys of it if its used in the primary keys\n            table.removeColumns(droppedTableColumns);\n            table.removePrimaryKeysOfColumns(droppedTableColumns);\n\n            // drop columns from the database\n            await this.queryRunner.dropColumns(table, droppedTableColumns);\n        });\n    }\n\n    /**\n     * Adds columns from metadata which does not exist in the table.\n     * Columns are created without keys.\n     */\n    protected addNewColumns() {\n        return PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n            const table = this.tables.find(table => table.name === metadata.tableName);\n            if (!table)\n                return;\n\n            // find which columns are new\n            const newColumnMetadatas = metadata.columns.filter(columnMetadata => {\n                return !table.columns.find(tableColumn => tableColumn.name === columnMetadata.databaseName);\n            });\n            if (newColumnMetadatas.length === 0)\n                return;\n\n            this.connection.logger.logSchemaBuild(`new columns added: ` + newColumnMetadatas.map(column => column.databaseName).join(\", \"));\n\n            // create columns in the database\n            const newTableColumns = this.metadataColumnsToTableColumns(newColumnMetadatas);\n            await this.queryRunner.addColumns(table, newTableColumns);\n            table.addColumns(newTableColumns);\n        });\n    }\n\n    /**\n     * Update all exist columns which metadata has changed.\n     * Still don't create keys. Also we don't touch foreign keys of the changed columns.\n     */\n    protected updateExistColumns() {\n        return PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n            const table = this.tables.find(table => table.name === metadata.tableName);\n            if (!table)\n                return;\n\n            const updatedTableColumns = table.findChangedColumns(this.connection.driver, metadata.columns);\n            if (updatedTableColumns.length === 0)\n                return;\n\n            this.connection.logger.logSchemaBuild(`columns changed in ${table.name}. updating: ` + updatedTableColumns.map(column => column.name).join(\", \"));\n\n            // drop all foreign keys that point to this column\n            const dropRelatedForeignKeysPromises = updatedTableColumns\n                .filter(changedTableColumn => !!metadata.columns.find(columnMetadata => columnMetadata.databaseName === changedTableColumn.name))\n                .map(changedTableColumn => this.dropColumnReferencedForeignKeys(metadata.tableName, changedTableColumn.name));\n\n            // wait until all related foreign keys are dropped\n            await Promise.all(dropRelatedForeignKeysPromises);\n\n            // drop all indices that point to this column\n            const dropRelatedIndicesPromises = updatedTableColumns\n                .filter(changedTableColumn => !!metadata.columns.find(columnMetadata => columnMetadata.databaseName === changedTableColumn.name))\n                .map(changedTableColumn => this.dropColumnReferencedIndices(metadata.tableName, changedTableColumn.name));\n\n            // wait until all related indices are dropped\n            await Promise.all(dropRelatedIndicesPromises);\n\n            // generate a map of new/old columns\n            const newAndOldTableColumns = updatedTableColumns.map(changedTableColumn => {\n                const columnMetadata = metadata.columns.find(column => column.databaseName === changedTableColumn.name);\n                const newTableColumn = TableColumn.create(columnMetadata!, \n                    this.connection.driver.normalizeType(columnMetadata!), \n                    this.connection.driver.normalizeDefault(columnMetadata!),\n                    this.connection.driver.getColumnLength(columnMetadata!));\n                table.replaceColumn(changedTableColumn, newTableColumn);\n\n                return {\n                    newColumn: newTableColumn,\n                    oldColumn: changedTableColumn\n                };\n            });\n\n            return this.queryRunner.changeColumns(table, newAndOldTableColumns);\n        });\n    }\n\n    /**\n     * Creates primary keys which does not exist in the table yet.\n     */\n    protected updatePrimaryKeys() {\n        return PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n            const table = this.tables.find(table => table.name === metadata.tableName && !table.justCreated);\n            if (!table)\n                return;\n\n            const metadataPrimaryColumns = metadata.columns.filter(column => column.isPrimary);\n            const addedKeys = metadataPrimaryColumns\n                .filter(primaryKey => {\n                    return !table.primaryKeys.find(dbPrimaryKey => dbPrimaryKey.columnName === primaryKey.databaseName);\n                })\n                .map(primaryKey => new TablePrimaryKey(\"\", primaryKey.databaseName));\n\n            const droppedKeys = table.primaryKeys.filter(primaryKeySchema => {\n                return !metadataPrimaryColumns.find(primaryKeyMetadata => primaryKeyMetadata.databaseName === primaryKeySchema.columnName);\n            });\n\n            if (addedKeys.length === 0 && droppedKeys.length === 0)\n                return;\n\n            this.connection.logger.logSchemaBuild(`primary keys of ${table.name} has changed: dropped - ${droppedKeys.map(key => key.columnName).join(\", \") || \"nothing\"}; added - ${addedKeys.map(key => key.columnName).join(\", \") || \"nothing\"}`);\n            table.addPrimaryKeys(addedKeys);\n            table.removePrimaryKeys(droppedKeys);\n            await this.queryRunner.updatePrimaryKeys(table);\n        });\n    }\n\n    /**\n     * Creates foreign keys which does not exist in the table yet.\n     */\n    protected createForeignKeys() {\n        return PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n            const table = this.tables.find(table => table.name === metadata.tableName);\n            if (!table)\n                return;\n\n            const newKeys = metadata.foreignKeys.filter(foreignKey => {\n                return !table.foreignKeys.find(dbForeignKey => dbForeignKey.name === foreignKey.name);\n            });\n            if (newKeys.length === 0)\n                return;\n\n            const dbForeignKeys = newKeys.map(foreignKeyMetadata => TableForeignKey.create(foreignKeyMetadata));\n            this.connection.logger.logSchemaBuild(`creating a foreign keys: ${newKeys.map(key => key.name).join(\", \")}`);\n            await this.queryRunner.createForeignKeys(table, dbForeignKeys);\n            table.addForeignKeys(dbForeignKeys);\n        });\n    }\n\n    /**\n     * Creates indices which are missing in db yet, and drops indices which exist in the db,\n     * but does not exist in the metadata anymore.\n     */\n    protected createIndices() {\n        // return Promise.all(this.connection.entityMetadatas.map(metadata => this.createIndices(metadata.table, metadata.indices)));\n        return PromiseUtils.runInSequence(this.entityToSyncMetadatas, async metadata => {\n            const table = this.tables.find(table => table.name === metadata.tableName);\n            if (!table)\n                return;\n\n            // drop all indices that exist in the table, but does not exist in the given composite indices\n            const dropQueries = table.indices\n                .filter(tableIndex => {\n                    const metadataIndex = metadata.indices.find(indexMetadata => indexMetadata.name === tableIndex.name);\n                    if (!metadataIndex)\n                        return true;\n                    if (metadataIndex.isUnique !== tableIndex.isUnique)\n                        return true;\n                    if (metadataIndex.columns.length !== tableIndex.columnNames.length)\n                        return true;\n                    if (metadataIndex.columns.findIndex((col, i) => col.databaseName !== tableIndex.columnNames[i]) !== -1)\n                        return true;\n                    \n                    return false;\n                })\n                .map(async tableIndex => {\n                    this.connection.logger.logSchemaBuild(`dropping an index: ${tableIndex.name}`);\n                    table.removeIndex(tableIndex);\n                    await this.queryRunner.dropIndex(metadata.tablePath, tableIndex.name);\n                });\n\n            await Promise.all(dropQueries);\n\n            // then create table indices for all composite indices we have\n            const addQueries = metadata.indices\n                .filter(indexMetadata => !table.indices.find(tableIndex => tableIndex.name === indexMetadata.name))\n                .map(async indexMetadata => {\n                    const tableIndex = TableIndex.create(indexMetadata);\n                    table.indices.push(tableIndex);\n                    this.connection.logger.logSchemaBuild(`adding new index: ${tableIndex.name}`);\n                    await this.queryRunner.createIndex(table, tableIndex);\n                });\n\n            await Promise.all(addQueries);\n        });\n    }\n\n    /**\n     * Drops all indices where given column of the given table is being used.\n     */\n    protected async dropColumnReferencedIndices(tableName: string, columnName: string): Promise<void> {\n\n        const table = this.tables.find(table => table.name === tableName);\n        if (!table)\n            return;\n\n        // find depend indices to drop them\n        const dependIndicesInTable = table.indices.filter(tableIndex => {\n            return tableIndex.tableName === tableName && !!tableIndex.columnNames.find(columnDatabaseName => columnDatabaseName === columnName);\n        });\n        if (dependIndicesInTable.length === 0)\n            return;\n\n        this.connection.logger.logSchemaBuild(`dropping related indices of ${tableName}#${columnName}: ${dependIndicesInTable.map(index => index.name).join(\", \")}`);\n\n        const dropPromises = dependIndicesInTable.map(index => {\n            table.removeIndex(index);\n            return this.queryRunner.dropIndex(table, index.name);\n        });\n\n        await Promise.all(dropPromises);\n    }\n\n    /**\n     * Drops all foreign keys where given column of the given table is being used.\n     */\n    protected async dropColumnReferencedForeignKeys(tableName: string, columnName: string): Promise<void> {\n\n        const allForeignKeyMetadatas = this.connection.entityMetadatas.reduce(\n            (all, metadata) => all.concat(metadata.foreignKeys),\n            [] as ForeignKeyMetadata[]\n        );\n\n        const table = this.tables.find(table => table.name === tableName);\n        if (!table)\n            return;\n\n        // find depend foreign keys to drop them\n        const dependForeignKeys = allForeignKeyMetadatas.filter(foreignKey => {\n            if (foreignKey.tableName === tableName) {\n                return !!foreignKey.columns.find(fkColumn => {\n                    return fkColumn.databaseName === columnName;\n                });\n            } else if (foreignKey.referencedTableName === tableName) {\n                return !!foreignKey.referencedColumns.find(fkColumn => {\n                    return fkColumn.databaseName === columnName;\n                });\n            }\n            return false;\n        });\n        if (!dependForeignKeys.length)\n            return;\n\n        const dependForeignKeyInTable = dependForeignKeys.filter(fk => {\n            return !!table.foreignKeys.find(dbForeignKey => dbForeignKey.name === fk.name);\n        });\n        if (dependForeignKeyInTable.length === 0)\n            return;\n\n        this.connection.logger.logSchemaBuild(`dropping related foreign keys of ${tableName}#${columnName}: ${dependForeignKeyInTable.map(foreignKey => foreignKey.name).join(\", \")}`);\n        const tableForeignKeys = dependForeignKeyInTable.map(foreignKeyMetadata => TableForeignKey.create(foreignKeyMetadata));\n        table.removeForeignKeys(tableForeignKeys);\n        await this.queryRunner.dropForeignKeys(table, tableForeignKeys);\n    }\n\n    /**\n     * Creates new columns from the given column metadatas.\n     */\n    protected metadataColumnsToTableColumns(columns: ColumnMetadata[]): TableColumn[] {\n        return columns.map(columnMetadata => {\n            return TableColumn.create(\n                columnMetadata,\n                this.connection.driver.normalizeType(columnMetadata),\n                this.connection.driver.normalizeDefault(columnMetadata),\n                this.connection.driver.getColumnLength(columnMetadata)\n            );\n        });\n    }\n\n}"],"sourceRoot":".."}